
<!DOCTYPE html>
<html>

<head>
    <!-- <link rel="stylesheet" href="./css/main_page.css" type="text/css">
    <link rel="stylesheet" href="flexslider.css" type="text/css">
    <link rel="stylesheet" href="css/rest.css" type="text/css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <!-- <script src="jquery.flexslider.js"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <title>allen pages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="css/style.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965Dz0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body style="background-color: whitesmoke;">
    <nav class="navbar navbar-expand-lg navbar-light bg-light" style="background-color: #708090;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="./dashboard.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Traceroute</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Webloading</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section id="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2"
                    style="height: 150px; margin-top: 25px; background-color: antiquewhite; text-align: center;">
                    <div>
                        <div class="container-fluid" id="position" style="margin-top: 50px;">
                            <p>管院</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-7" style="margin-top: 120px; text-align:center;">
                    <!-- <div id="switch">
                        <button id="btn_traceroute">T</button>
                        <button id="btn_webloading">W</button>
                    </div> -->
                </div>
                <div class="col-md-3" style="margin-top: 25px; height:150px ; background-color: antiquewhite; text-align: center;">
                    <div id="full_log" style="margin-top: 49px; ">
                        <a href="./all_log.html"><h1 style="color: black;">完整LOG紀錄</h1></a>
                        
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="last_hop">
        <div class="container-fluid" style="margin-top: 30px;">
            <div class="row" style="height: 600px;">
                <div class="col-md-8 text-center" style="display: flex; flex-direction: column;">
                    <div class="container-fluid" style="background-color: rgb(241, 241, 236); flex: 1;">
                        <canvas id="chart1" width="400" height="300"></canvas>
                    </div>
                    <div class="container-fluid" style="background-color: lightgray; flex: 1;">
                        <canvas id="chart2" width="400" height="300"></canvas>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="row-md-2" style="background-color: lightgray; color: rgb(66, 64, 64);" id="avg_RTT">
                        <h1>歷史平均RTT</h1>
                    </div>
                    <div class="row-md-2" style="background-color: lightgray;color: rgb(66, 64, 64);" id="last_RTT">
                        <h1>最新一筆平均RTT</h1>
                    </div>
                    <div class="row-md-2" style="background-color: lightgray;color: rgb(66, 64, 64);" id="exceed_RTT">
                        <h1>超過平均RTT</h1>
                    </div>
                    <div class="row-md-2" style="background-color: lightgray;color: rgb(66, 64, 64);" id="avg_web">
                        <h1>網站載入歷史平均時間</h1>
                    </div>
                    <div class="row-md-2" style="background-color: lightgray;color: rgb(66, 64, 64);" id="last_web">
                        <h1>最新一筆網站平均</h1>
                    </div>
                    <div class="row-md-2" style="background-color: lightgray;color: rgb(66, 64, 64);" id="exceed_web">
                        <h1>超過網站平均時間</h1>
                    </div>
                </div>
            </div>
        </div>
    </section>

    
    
    

    <script>
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const location = urlParams.get('location');
            const mode = urlParams.get('mode');
            let AVG = {};
    
            async function fetchAVGData() {
                try {
                    const traceroute_avg = await fetch('./data/traceroute_avg.json');
                    const webloading_avg = await fetch('./data/webloading_avg_webpage.json');
                    if (!traceroute_avg.ok) {
                        throw new Error('traceroute_avg請求失敗');
                    }
                    else if (! webloading_avg.ok){
                        throw new Error('webloading_avg請求失敗');
                    }
                    traceroute_AVG = await traceroute_avg.json();
                    webloading_AVG = await webloading_avg.json();
                } catch (error) {
                    console.error('获取 AVG_JSON 时出错：', error);
                }
            }
    
            function AVGtime_dispaly(data, targetElementId) {
                var dcardElement = document.getElementById(targetElementId);
                dcardElement.innerHTML = '';
                console.log(data);
            }
    
            fetchAVGData()
                .then(() => {
                    fetchDataAndProcess('./data/dashboard.json', 'position', location, mode, traceroute_AVG);
                    fetchDataAndProcess('./data/traceroute_log_webpage.json', 'log_data', location, mode, traceroute_AVG);
                    
                    fetchDataAndProcess('./data/dashboard.json', 'position', location, mode, webloading_AVG);
                    fetchDataAndProcess('./data/webloading_history_webpage.json', 'log_data2', location, mode, webloading_AVG);
                });
        };
    
        function fetchDataAndProcess(jsonFilePath, targetElementId, location, mode, AVG) {
            fetch(jsonFilePath)
                .then(function (response) {
                    return response.json();
                })
                .then(function (jsonData) {
                    switch (targetElementId) {
                        case 'position':
                            var dcardElement = document.getElementById(targetElementId);
                            dcardElement.innerHTML = '';
                            var row = `<h1>${location}</h1>`;
                            dcardElement.innerHTML += row;
                            break;
                        case 'log_data':
                            var dcardElement = document.getElementById(targetElementId);
    
                            var chart1Canvas = document.getElementById('chart1'); // 获取Canvas元素（chart1）
                            var chart1Data = {
                                labels: [], // 标签数据
                                datasets: [{
                                    label: 'RTT', // 数据集标签
                                    data: [], // 数据集数据
                                    borderColor: "black",
                                    fill: false,
                                    pointRadius: 0 // 設置點的半徑為0
                                    
                                    
                                },
                                {
                                    label: "AVG", // 第二个数据集标签
                                    data: [], // 第二个数据集数据
                                    borderColor: "red",
                                    fill: false, // 這將不會顯示點
                                    pointRadius: 0 // 設置點的半徑為0
                                    
                                }
                                ]
                            };
    
                            let traceroute_avg = 0;
                            for (const key in AVG) {
                                if (AVG.hasOwnProperty(key)) {
                                    const hop = AVG[key];
                                    if (hop.host === "dns.hinet.net (168.95.1.1)") {
                                        traceroute_avg = hop.latency;
                                        break;
                                    }
                                }
                            }
    
                            const hisRTTElement = document.getElementById('avg_RTT');
                            if (hisRTTElement) {
                                hisRTTElement.innerHTML = '<h2>歷史平均RTT</h2>' + '<h1>' + traceroute_avg + 'ms' + '</h1>';
                            }
    
                            const lastjsonData = jsonData.slice(-1);
                            const lastRTTElement = document.getElementById('last_RTT');
                            let latencyValues = [];
    
                            for (const last_data of lastjsonData) {
                                const last_traceroute = last_data.traceroute;
                                for (const last_route of last_traceroute) {
                                    if (last_route.host === "dns.hinet.net (168.95.1.1)") {
                                        latencyValues = last_route.latency;
                                    }
                                }
                            }
    
                            const sum = latencyValues.reduce((total, value) => total + parseFloat(value), 0);
                            const average = sum / latencyValues.length;
    
                            lastRTTElement.innerHTML = '<h2>最新一筆平均RTT</h2>' + '<h1>' + average.toFixed(2) + 'ms' + '</h1>';
                            const exceedRTTElement = document.getElementById('exceed_RTT');
                            if (average > traceroute_avg) {
                                const exceedPercentage = ((average - traceroute_avg) / traceroute_avg * 100).toFixed(2);
                                if(exceedPercentage>300){
                                    exceedRTTElement.innerHTML = '<h2 style = "color: rgb(170, 0, 0)";>超過平均RTT</h2>' + '<h1 style = "color: rgb(170, 0, 0)">超過' + exceedPercentage + '%</h1>';
                                }else{
                                    exceedRTTElement.innerHTML = '<h2>超過平均RTT</h2>' + '<h1>超過' + exceedPercentage + '%</h1>';
                                }
                                
                            } else {
                                exceedRTTElement.innerHTML = '<h2>最新一筆超過歷史平均RTT</h2>' + '<h1>0%</h1>';
                            }
    
                            
    
                            const jsonDataSlice = jsonData.slice(-288);
    
                            for (const data of jsonDataSlice) {
                                const traceroute = data.traceroute;
                                for (const route of traceroute) {
                                    if (route.host === "dns.hinet.net (168.95.1.1)") {
                                        const node_latencyValues = route.latency;
                                        const node_sum = node_latencyValues.reduce((total, value) => total + parseFloat(value), 0);
                                        const node_average = node_sum / node_latencyValues.length;
                                        const timePart = data.timetmp.split(' ')[1];
                                        chart1Data.labels.push(timePart);
                                        chart1Data.datasets[0].data.push(parseFloat(node_average));
                                        chart1Data.datasets[1].data.push(traceroute_avg);
                                    }
                                }
                            }
    
                            options = {
                            plugins: {
                                title: {
                                    display: true,
                                    text: '過去24小時網路狀況',
                                },
                            },
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        
                                    },
                                    ticks: {
                                        maxRotation: 90,  // 最大旋转角度
                                        minRotation: 45,  // 最小旋转角度
                                    },
                                },
                                y: {
                                    min: 0,
                                    max: 160,
                                },
                            },
                        };
    
                            var ctx1 = chart1Canvas.getContext('2d'); // 获取Canvas上下文（ctx1）
                            new Chart(ctx1, {
                                type: 'line',
                                data: chart1Data,
                                options: options
                            });
    
                            break;
    
                        case 'log_data2':
                            var dcardElement = document.getElementById(targetElementId);
                            var chart2Canvas = document.getElementById('chart2');
                            var chart2Data = {
                                labels: [], // 标签数据
                                datasets: [{
                                    label: '網站平均時間', // 数据集标签
                                    data: [], // 数据集数据
                                    borderColor: "black",
                                    fill: false,
                                    pointRadius: 0 // 設置點的半徑為0
                                },
                                {
                                    label: "AVG", // 第二个数据集标签
                                    data: [], // 第二个数据集数据
                                    borderColor: "red",
                                    fill: false, // 這將不會顯示點
                                    pointRadius: 0 ,// 設置點的半徑為0
                                    pointHitRadius: 5 // 增加感应半径的大小，这里设置为10，你可以根据需要调整

                                }
                                ]
                            };

                            let webloading_avg = 0;
                            let totalLoadTime = 0;
                            let loadTimeCount = 0;

                            for (const key in AVG) {
                                if (AVG.hasOwnProperty(key)) {
                                    const avgData = AVG[key];
                                    if (avgData.load_time_seconds) {
                                        totalLoadTime += avgData.load_time_seconds;
                                        loadTimeCount++;
                                    }
                                }
                            }

                            if (loadTimeCount > 0) {
                                webloading_avg = totalLoadTime / loadTimeCount;
                            }

                            const jsonDataSlice2 = jsonData.slice(-110);
                            const loadingTimes = []; // 用于存储所有的 loading_time

                            for (const data2 of jsonDataSlice2) {
                                const webloading = data2.data;
                                let sum = 0; // 用于计算每个时间戳的总和

                                for (const route2 of webloading) {
                                    const node_latencyValue2 = route2.loading_time;
                                    sum += parseFloat(node_latencyValue2);
                                }
                                
                                const averageLoadingTime = sum / webloading.length; // 计算平均 loading_time
                                lastAverageLoadingTime = averageLoadingTime;
                                const timePart2 = data2.timestamp.split(' ')[1];
                                chart2Data.labels.push(timePart2);
                                chart2Data.datasets[0].data.push(averageLoadingTime);
                                chart2Data.datasets[1].data.push(webloading_avg);
                                
                            }
                            
                            
                            const hiswebElement = document.getElementById('avg_web');
                            if (hiswebElement) {
                                hiswebElement.innerHTML = '<h2>網站載入歷史平均時間</h2>' + '<h1>' + webloading_avg.toFixed(3) + 's' + '</h1>';
                            }
    
                            
                            const lastwebElement = document.getElementById('last_web');
                            lastwebElement.innerHTML = '<h2>最新一筆網站平均時間</h2>' + '<h1>' + lastAverageLoadingTime.toFixed(2) + 's' + '</h1>';
    
                            const exceedwebElement = document.getElementById('exceed_web');
                            if (lastAverageLoadingTime > webloading_avg) {
                                const exceedPercentage_web = ((lastAverageLoadingTime - webloading_avg) / webloading_avg * 100).toFixed(2);
                                if(exceedPercentage_web>150){
                                    exceedwebElement.innerHTML = '<h2 style = "color: rgb(170, 0, 0)">超過網站平均時間</h2>' + '<h1 style = "color: rgb(170, 0, 0)">超過' + exceedPercentage_web + '%</h1>';
                                }else{
                                    exceedwebElement.innerHTML = '<h2>超過網站平均時間</h2>' + '<h1>超過' + exceedPercentage_web + '%</h1>';
                                }
                            } else {
                                exceedwebElement.innerHTML = '<h2>最新一筆超過網站歷史平均</h2>' + '<h1>0%</h1>';
                            }
    
                            

                            
                            options = {
                            plugins: {
                                title: {
                                    display: true,
                                    text: '過去24小時網路狀況',
                                },
                            },
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        
                                    },
                                    ticks: {
                                        maxRotation: 90,  // 最大旋转角度
                                        minRotation: 45,  // 最小旋转角度
                                    },
                                },
                                y: {
                                    min: 0,
                                    max: 160,
                                },
                            },
                        };

                            var ctx2 = chart2Canvas.getContext('2d');
                            new Chart(ctx2, {
                                type: 'line',
                                data: chart2Data,
                                options: options
                            });

                            break;
                        
    
                        default:
                            console.error('未知的目标元素 ID: ' + targetElementId);
                            break;
    
                    }
                })
                .catch(function (error) {
                    console.error('获取 JSON 时出错：', error);
                });
        }
    
        
    </script>
    
</body>

</html>
